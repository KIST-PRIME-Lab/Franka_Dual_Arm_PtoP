#!/usr/bin/env python3
"""
Isaac pc ì—ì„œ ì‹¤í–‰ë˜ëŠ” pythob file ì˜ˆì œ
Isaac ROS2 Bridge - í…ŒìŠ¤íŠ¸ìš© ë…¸ë“œ

shm_ros2_bridgeì™€ í†µì‹ í•˜ì—¬ ë°ì´í„° ì†¡ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
ë‚˜ì¤‘ì— Isaac Sim PCì—ì„œ ì‹¤í–‰í•  ë…¸ë“œì˜ í…œí”Œë¦¿

êµ¬ì¡°:
  franka, hand <-> shm <-> /shm_ros2_bridge <-> /isaac_ros2_bridge (ì´ ë…¸ë“œ)

ì—­í• :
  - arm_state, hand_stateë¥¼ subscribe (ë¡œë´‡ ìƒíƒœ ìˆ˜ì‹ )
  - arm_target, hand_targetì„ publish (ë¡œë´‡ ëª©í‘œ ì „ì†¡)
"""

import rclpy
from rclpy.node import Node
from rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy, DurabilityPolicy
import numpy as np
import math

# ë©”ì‹œì§€ íƒ€ì… import
from kistar_hand_ros2.msg import FrankaArmState, FrankaArmTarget
from kistar_hand_ros2.msg import HandState, HandTarget


class IsaacRos2Bridge(Node):
    def __init__(self):
        super().__init__('isaac_ros2_bridge')
        
        self.get_logger().info('ğŸš€ Isaac ROS2 Bridge ì‹œì‘')
        
        # QoS ì„¤ì • (shm_ros2_bridgeì™€ í˜¸í™˜ë˜ë„ë¡)
        qos = QoSProfile(
            reliability=ReliabilityPolicy.RELIABLE,
            durability=DurabilityPolicy.VOLATILE,
            history=HistoryPolicy.KEEP_LAST,
            depth=10
        )
        
        # ============================================
        # Subscribers (ë¡œë´‡ ìƒíƒœ ìˆ˜ì‹ )
        # ============================================
        
        # Franka Arm State (ì˜¤ë¥¸ìª½)
        self.sub_arm_state_R = self.create_subscription(
            FrankaArmState,
            '/franka/arm_state/right',
            self.arm_state_callback_R,
            qos
        )
        
        # Franka Arm State (ì™¼ìª½)
        self.sub_arm_state_L = self.create_subscription(
            FrankaArmState,
            '/franka/arm_state/left',
            self.arm_state_callback_L,
            qos
        )
        
        # Hand State (ì˜¤ë¥¸ìª½)
        self.sub_hand_state_R = self.create_subscription(
            HandState,
            '/hand/state/right',
            self.hand_state_callback_R,
            qos
        )
        
        # Hand State (ì™¼ìª½)
        self.sub_hand_state_L = self.create_subscription(
            HandState,
            '/hand/state/left',
            self.hand_state_callback_L,
            qos
        )
        
        # ============================================
        # Publishers (ë¡œë´‡ ëª©í‘œ ì „ì†¡)
        # ============================================
        
        # Franka Arm Target
        self.pub_arm_target_R = self.create_publisher(
            FrankaArmTarget,
            '/franka/arm_target/right',
            qos
        )
        self.pub_arm_target_L = self.create_publisher(
            FrankaArmTarget,
            '/franka/arm_target/left',
            qos
        )
        
        # Hand Target
        self.pub_hand_target_R = self.create_publisher(
            HandTarget,
            '/hand/target/right',
            qos
        )
        self.pub_hand_target_L = self.create_publisher(
            HandTarget,
            '/hand/target/left',
            qos
        )
        
        # ============================================
        # ë‚´ë¶€ ìƒíƒœ ì €ì¥
        # ============================================
        self.arm_state_R = None
        self.arm_state_L = None
        self.hand_state_R = None
        self.hand_state_L = None
        
        self.receive_count = 0
        self.send_count = 0
        
        # ============================================
        # íƒ€ì´ë¨¸ (ìƒíƒœ ì¶œë ¥ ë° í…ŒìŠ¤íŠ¸ ëª©í‘œ ì „ì†¡)
        # ============================================
        
        # ìƒíƒœ ì¶œë ¥ íƒ€ì´ë¨¸ (1Hz)
        self.print_timer = self.create_timer(1.0, self.print_status)
        
        # í…ŒìŠ¤íŠ¸ ëª©í‘œ ì „ì†¡ íƒ€ì´ë¨¸ (ë¹„í™œì„±í™” ìƒíƒœ, í•„ìš”ì‹œ í™œì„±í™”)
        # self.target_timer = self.create_timer(0.1, self.send_test_target)
        
        self.get_logger().info('âœ… ëª¨ë“  subscriber/publisher ì´ˆê¸°í™” ì™„ë£Œ')
        self.get_logger().info('ğŸ“¡ /shm_ros2_bridgeì™€ í†µì‹  ëŒ€ê¸° ì¤‘...')
    
    # ============================================
    # Callback í•¨ìˆ˜ë“¤ (ìƒíƒœ ìˆ˜ì‹ )
    # ============================================
    
    def arm_state_callback_R(self, msg: FrankaArmState):
        self.arm_state_R = msg
        self.receive_count += 1
        if self.receive_count % 100 == 1:  # 100ë²ˆë§ˆë‹¤ í•œ ë²ˆì”© ì¶œë ¥
            self.get_logger().info(f'ğŸ”” ì½œë°± í˜¸ì¶œë¨! joint[0]={msg.joint_positions[0]:.3f}')
    
    def arm_state_callback_L(self, msg: FrankaArmState):
        self.arm_state_L = msg
        self.receive_count += 1
    
    def hand_state_callback_R(self, msg: HandState):
        self.hand_state_R = msg
        self.receive_count += 1
    
    def hand_state_callback_L(self, msg: HandState):
        self.hand_state_L = msg
        self.receive_count += 1
    
    # ============================================
    # ìƒíƒœ ì¶œë ¥
    # ============================================
    
    def print_status(self):
        self.get_logger().info('=' * 60)
        self.get_logger().info(f'ğŸ“Š ìˆ˜ì‹  ì¹´ìš´íŠ¸: {self.receive_count}, ì „ì†¡ ì¹´ìš´íŠ¸: {self.send_count}')
        
        # Franka Arm ìƒíƒœ ì¶œë ¥
        if self.arm_state_R is not None:
            pos = [f'{p:.3f}' for p in self.arm_state_R.joint_positions]
            self.get_logger().info(f'ğŸ¦¾ Franka R ê´€ì ˆ [rad]: [{", ".join(pos)}]')
            
            tq = [f'{t:.2f}' for t in self.arm_state_R.joint_torques]
            self.get_logger().info(f'   Franka R í† í¬ [Nm]: [{", ".join(tq)}]')
        else:
            self.get_logger().warn('âš ï¸  Franka R ìƒíƒœ: ìˆ˜ì‹  ì•ˆë¨')
        
        if self.arm_state_L is not None:
            pos = [f'{p:.3f}' for p in self.arm_state_L.joint_positions]
            self.get_logger().info(f'ğŸ¦¾ Franka L ê´€ì ˆ [rad]: [{", ".join(pos)}]')
        else:
            self.get_logger().warn('âš ï¸  Franka L ìƒíƒœ: ìˆ˜ì‹  ì•ˆë¨')
        
        # Hand ìƒíƒœ ì¶œë ¥
        if self.hand_state_R is not None:
            pos = list(self.hand_state_R.joint_positions[:5])  # ì²˜ìŒ 5ê°œë§Œ
            self.get_logger().info(f'âœ‹ Hand R ê´€ì ˆ (ì²˜ìŒ 5ê°œ): {pos}')
        else:
            self.get_logger().warn('âš ï¸  Hand R ìƒíƒœ: ìˆ˜ì‹  ì•ˆë¨')
        
        if self.hand_state_L is not None:
            pos = list(self.hand_state_L.joint_positions[:5])
            self.get_logger().info(f'âœ‹ Hand L ê´€ì ˆ (ì²˜ìŒ 5ê°œ): {pos}')
        else:
            self.get_logger().warn('âš ï¸  Hand L ìƒíƒœ: ìˆ˜ì‹  ì•ˆë¨')
    
    # ============================================
    # ëª©í‘œ ì „ì†¡ í•¨ìˆ˜ë“¤
    # ============================================
    
    def send_arm_target(self, arm_id: int, joint_targets: list):
        """
        Franka Arm ëª©í‘œ ì „ì†¡
        
        Args:
            arm_id: 0=Right, 1=Left
            joint_targets: 7ê°œì˜ ê´€ì ˆ ëª©í‘œ [rad]
        """
        msg = FrankaArmTarget()
        msg.arm_id = arm_id
        msg.joint_targets = joint_targets
        
        if arm_id == 0:
            self.pub_arm_target_R.publish(msg)
        else:
            self.pub_arm_target_L.publish(msg)
        
        self.send_count += 1
        self.get_logger().info(f'ğŸ“¤ Arm Target ì „ì†¡ (id={arm_id}): {[f"{t:.3f}" for t in joint_targets]}')
    
    def send_hand_target(self, hand_id: int, joint_targets: list, duration: float = 1.0):
        """
        Hand ëª©í‘œ ì „ì†¡
        
        Args:
            hand_id: 0=Right, 1=Left
            joint_targets: 16ê°œì˜ ê´€ì ˆ ëª©í‘œ
            duration: ì´ë™ ì‹œê°„ [ì´ˆ]
        """
        msg = HandTarget()
        msg.hand_id = hand_id
        msg.joint_targets = joint_targets
        msg.movement_duration = duration
        
        if hand_id == 0:
            self.pub_hand_target_R.publish(msg)
        else:
            self.pub_hand_target_L.publish(msg)
        
        self.send_count += 1
        self.get_logger().info(f'ğŸ“¤ Hand Target ì „ì†¡ (id={hand_id}): {joint_targets[:5]}...')
    
    def send_both_targets(self, arm_id: int, arm_joint_targets: list, 
                          hand_id: int, hand_joint_targets: list, 
                          hand_duration: float = 1.0):
        """
        Armê³¼ Handë¥¼ ë™ì‹œì— ëª©í‘œ ì „ì†¡
        
        Args:
            arm_id: 0=Right, 1=Left
            arm_joint_targets: 7ê°œì˜ Arm ê´€ì ˆ ëª©í‘œ [rad]
            hand_id: 0=Right, 1=Left
            hand_joint_targets: 16ê°œì˜ Hand ê´€ì ˆ ëª©í‘œ
            hand_duration: Hand ì´ë™ ì‹œê°„ [ì´ˆ]
        """
        # Arm Target ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
        arm_msg = FrankaArmTarget()
        arm_msg.arm_id = arm_id
        arm_msg.joint_targets = arm_joint_targets
        
        # Hand Target ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
        hand_msg = HandTarget()
        hand_msg.hand_id = hand_id
        hand_msg.joint_targets = hand_joint_targets
        hand_msg.movement_duration = hand_duration
        
        # ë™ì‹œì— publish (ê±°ì˜ ë™ì‹œì— ì „ì†¡ë¨)
        if arm_id == 0:
            self.pub_arm_target_R.publish(arm_msg)
        else:
            self.pub_arm_target_L.publish(arm_msg)
        
        if hand_id == 0:
            self.pub_hand_target_R.publish(hand_msg)
        else:
            self.pub_hand_target_L.publish(hand_msg)
        
        self.send_count += 2
        self.get_logger().info(f'ğŸ“¤ Arm + Hand ë™ì‹œ ì „ì†¡ ì™„ë£Œ!')
        self.get_logger().info(f'   Arm (id={arm_id}): {[f"{t:.3f}" for t in arm_joint_targets]}')
        self.get_logger().info(f'   Hand (id={hand_id}): {hand_joint_targets[:5]}...')
    
    def send_test_target(self):
        """
        í…ŒìŠ¤íŠ¸ìš© ëª©í‘œ ì „ì†¡ (íƒ€ì´ë¨¸ì—ì„œ í˜¸ì¶œ)
        í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì•½ê°„ì˜ ì˜¤í”„ì…‹ ì¶”ê°€
        """
        if self.arm_state_R is not None:
            # í˜„ì¬ ìœ„ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ëª©í‘œë¡œ (ì•ˆì „)aac ROS2 Bridge - í…ŒìŠ¤íŠ¸ìš© ë…¸ë“œ

# shm_ros2_bridgeì™€ í†µì‹ í•˜ì—¬ ë°ì´í„° ì†¡ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
# ë‚˜ì¤‘ì— Isaac Sim PCì—ì„œ ì‹¤í–‰í•  ë…¸ë“œì˜ í…œí”Œë¦¿

# êµ¬ì¡°:
#   franka, hand <-> shm <-> /shm_ros2_bridge <-> /isaac_ros2_bridge (ì´ ë…¸ë“œ)

# ì—­í• :
#     rclpy.init(args=args)
    
#     node = IsaacRos2Bridge()
    
#     print()
#     print('=' * 60)
#     print('  Isaac ROS2 Bridge - í…ŒìŠ¤íŠ¸ ë…¸ë“œ')
#     print('=' * 60)
#     print()
#     print('  ëª…ë ¹ì–´:')
#     print('    Ctrl+C : ì¢…ë£Œ')
#     print()
#     print('  rqt_graphì—ì„œ ì—°ê²° í™•ì¸ ê°€ëŠ¥')
#     print('=' * 60)
#     print()
    
#     try:
#         rclpy.spin(node)
#     except KeyboardInterrupt:
#         node.get_logger().info('ğŸ‘‹ ì¢…ë£Œ ìš”ì²­ë¨')
#     finally:
#         node.destroy_node()
#         rclpy.shutdown()


# if __name__ == '__main__':
#     main()